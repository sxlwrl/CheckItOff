<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="icon" href="/img/head_icon.jpg" />
    <link
        href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600&display=swap"
        rel="stylesheet"
    />
    <title>CheckItOff</title>
    <script>
        function toggleForm() {
            const form = document.getElementById('taskForm');
            const btn = document.getElementById('addTask');
            form.classList.toggle('hidden');
            btn.classList.toggle('hidden');
        }

        window.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('date');
            dateInput.min = new Date().toISOString().split('T')[0];
        });

        function showButtons(taskItem) {
            const btns = taskItem.querySelector('.btns');
            btns.style.display = 'flex';
        }

        function updateTaskStatus(taskId, status) {
            fetch(`/main/task/${taskId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    status: status,
                }),
            })
                .then((response) => {
                    if (response.ok) {
                        const taskItem = document.getElementById(`task${taskId}`);
                        taskItem.classList.toggle('complete');
                    } else {
                        console.error('Failed to update task status');
                    }
                })
                .catch((error) => {
                    console.error(error);
                });
        }

        window.addEventListener('DOMContentLoaded', () => {
            const taskItems = document.querySelectorAll('li');
            taskItems.forEach((item) => {
                item.addEventListener('mouseover', () => {
                    const btns = item.querySelector('.btns');
                    if (!item.classList.contains('complete')) {
                        btns.classList.remove('hidden');
                    }

                });
                item.addEventListener('mouseout', () => {
                    const btns = item.querySelector('.btns');
                    btns.classList.add('hidden');
                });

            })
        });

    </script>
</head>
<body>
<header>
    <p class="hello"> Welcome back, {{user.USERNAME}}</p>
    <button id="Logout"><a href="/auth/logout">
        <svg xmlns="http://www.w3.org/2000/svg" id="Outline" viewBox="0 0 24 24" width="20" height="20">
            <path
                d="M22.829,9.172,18.95,5.293a1,1,0,0,0-1.414,1.414l3.879,3.879a2.057,2.057,0,0,1,.3.39c-.015,0-.027-.008-.042-.008h0L5.989,11a1,1,0,0,0,0,2h0l15.678-.032c.028,0,.051-.014.078-.016a2,2,0,0,1-.334.462l-3.879,3.879a1,1,0,1,0,1.414,1.414l3.879-3.879a4,4,0,0,0,0-5.656Z" />
            <path
                d="M7,22H5a3,3,0,0,1-3-3V5A3,3,0,0,1,5,2H7A1,1,0,0,0,7,0H5A5.006,5.006,0,0,0,0,5V19a5.006,5.006,0,0,0,5,5H7a1,1,0,0,0,0-2Z" />
        </svg>
    </a>
    </button>
</header>

<section class="Task-list">

    <h1>Task List</h1>

    <div class="view-content">
        <ul>
            {{#each tasks}}
                <li {{#unless this.task_status}} class='complete' {{/unless}} id='task{{this.task_id}}' onmouseover='showButtons({{this}})'>
                    <div class="divInLi">
                        <input
                            type="checkbox"
                            class="taskCheckbox"
                            id="taskCheckbox{{this.task_id}}"
                            onchange="updateTaskStatus('{{this.task_id}}', !this.checked)"
                            {{#unless this.task_status}}checked{{/unless}}
                        />
                        <p>{{this.task_name}}</p>
                        <p>{{this.task_description}}</p>
                        <p>{{this.task_priority}}</p>
                        <p>{{formatDate this.task_date}}</p>
                    </div>
                    <div class="btns hidden">
                        <a class="editTask" href="/main/task/{{this.task_id}}/edit">
                            <svg xmlns="http://www.w3.org/2000/svg" id="Outline" viewBox="0 0 24 24" width="10"
                                 height="10">
                                <path
                                    d="M22.853,1.148a3.626,3.626,0,0,0-5.124,0L1.465,17.412A4.968,4.968,0,0,0,0,20.947V23a1,1,0,0,0,1,1H3.053a4.966,4.966,0,0,0,3.535-1.464L22.853,6.271A3.626,3.626,0,0,0,22.853,1.148ZM5.174,21.122A3.022,3.022,0,0,1,3.053,22H2V20.947a2.98,2.98,0,0,1,.879-2.121L15.222,6.483l2.3,2.3ZM21.438,4.857,18.932,7.364l-2.3-2.295,2.507-2.507a1.623,1.623,0,1,1,2.295,2.3Z" />
                            </svg>
                        </a>
                        <form action="/main/task/{{this.task_id}}/delete" method="POST">
                            <button type="submit" id="deleteBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" id="Outline" viewBox="0 0 24 24" width="10"
                                     height="10">
                                    <path
                                        d="M23.707.293h0a1,1,0,0,0-1.414,0L12,10.586,1.707.293a1,1,0,0,0-1.414,0h0a1,1,0,0,0,0,1.414L10.586,12,.293,22.293a1,1,0,0,0,0,1.414h0a1,1,0,0,0,1.414,0L12,13.414,22.293,23.707a1,1,0,0,0,1.414,0h0a1,1,0,0,0,0-1.414L13.414,12,23.707,1.707A1,1,0,0,0,23.707.293Z" />
                                </svg>
                            </button>
                        </form>
                    </div>
                </li>
            {{/each}}
        </ul>

        <button id="addTask" onclick="toggleForm()">Add Task</button>

        {{#if editing}}
        <form id="taskForm" action="/main/task/{{taskID}}" method="POST" class="">
        {{else}}
        <form id="taskForm" action="/main/task" method="POST" class="hidden">
        {{/if}}
        <input type="text" placeholder="Name" id="name" name="name" value="{{task.task_name}}" required>
        <input type="text" placeholder="What`s your task?" id="description" value="{{task.task_description}}"
               name="description">
        <select id="priority" name="priority" required>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
        </select>
        <input type="date" id="date" name="date" required>
        {{#if editing}}
            <button class="editTask" type="submit">Edit Task</button>
        {{else}}
            <button id="addTask" type="submit">Add Task</button>
        {{/if}}
        {{#if editing}}
            <button class="cancel-but"><a href="/main">Cancel</a></button>
        </form>
        {{else}}
            <button type="button" class="cancel-but toggle" onclick="toggleForm()">Cancel</button>
        </form>
        {{/if}}
    </div>
    </div>
</section>
</body>
</html>